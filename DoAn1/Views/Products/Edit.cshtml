@model DoAn1.Areas.Admin.Models.Product

@{
    ViewData["Title"] = "Chỉnh sửa sản phẩm";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2 class="mt-3 mb-4">Chỉnh sửa thông tin sản phẩm</h2>

<div class="row">
    <div class="col-md-8">
        <form asp-action="Edit" enctype="multipart/form-data">
            @Html.AntiForgeryToken()
            <input type="hidden" asp-for="ProductId" />

            <input type="hidden" asp-for="UserId" />
            <input type="hidden" asp-for="Status" />
            <input type="hidden" asp-for="IsActive" />
            <input type="hidden" asp-for="CreatedAt" />
            <input type="hidden" asp-for="TotalRating" />
            <input type="hidden" asp-for="RatingCount" />


            <div class="mb-3">
                <label asp-for="Title" class="form-label">Tên sản phẩm</label>
                <input asp-for="Title" class="form-control" />
                <span asp-validation-for="Title" class="text-danger"></span>
            </div>

            <div class="mb-3">
                <label asp-for="Description" class="form-label">Mô tả</label>
                <textarea asp-for="Description" class="form-control" rows="4"></textarea>
                <span asp-validation-for="Description" class="text-danger"></span>
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label asp-for="Price" class="form-label">Giá bán (VNĐ)</label>
                    <input asp-for="Price" class="form-control" />
                    <span asp-validation-for="Price" class="text-danger"></span>
                </div>
                <div class="col-md-6">
                    <label asp-for="Condition" class="form-label">Tình trạng</label>
                    <select asp-for="Condition" class="form-select">
                        <option value="Mới">Mới</option>
                        <option value="Cũ">Cũ</option>
                    </select>
                    <span asp-validation-for="Condition" class="text-danger"></span>
                </div>
            </div>

            <div class="mb-3">
                <label asp-for="Location" class="form-label">Địa chỉ</label>
                <input asp-for="Location" class="form-control" />
                <span asp-validation-for="Location" class="text-danger"></span>
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label asp-for="CategoryId" class="form-label">Danh mục</label>
                    <select asp-for="CategoryId" class="form-select" asp-items="ViewBag.CategoryId" id="CategoryId"></select>
                    <span asp-validation-for="CategoryId" class="text-danger"></span>
                </div>
                <div class="col-md-6">
                    <label asp-for="SubCategoryId" class="form-label">Loại</label>
                    <select asp-for="SubCategoryId" class="form-select" asp-items="ViewBag.SubCategoryId" id="SubCategoryId"></select>
                    <span asp-validation-for="SubCategoryId" class="text-danger"></span>
                </div>
            </div>

            <div class="mb-3">
                <label asp-for="Brand" class="form-label">Thương hiệu</label>
                <input asp-for="Brand" class="form-control" />
                <span asp-validation-for="Brand" class="text-danger"></span>
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label asp-for="WarrantyPeriod" class="form-label">Bảo hành (tháng)</label>
                    <input asp-for="WarrantyPeriod" class="form-control" />
                    <span asp-validation-for="WarrantyPeriod" class="text-danger"></span>
                </div>
                <div class="col-md-6">
                    <label asp-for="UsedDuration" class="form-label">Đã sử dụng (tháng)</label>
                    <input asp-for="UsedDuration" class="form-control" />
                    <span asp-validation-for="UsedDuration" class="text-danger"></span>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">Trạng thái bán</label><br />
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" asp-for="IsSold" value="false" checked />
                    <label class="form-check-label">Chưa bán</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" asp-for="IsSold" value="true" />
                    <label class="form-check-label">Đã bán</label>
                </div>
                <span asp-validation-for="IsSold" class="text-danger"></span>
            </div>

            <div class="mb-3">
                <label class="form-label">Hình ảnh hiện tại</label>
                <div class="row" id="image-list">
                    @foreach (var img in Model.ProductImages)
                    {
                        <div class="col-md-3 text-center" id="image-@img.ImageId">
                            <img src="@img.ImageUrl" style="width: 100%; height: 150px; object-fit: cover;" class="border mb-2" />
                            <div>
                                <button type="button" class="btn btn-danger btn-sm delete-image" data-id="@img.ImageId">
                                    Xóa ảnh
                                </button>
                            </div>
                        </div>
                    }
                </div>
            </div>


            <div class="mb-3">
                <label class="form-label">Thêm ảnh mới</label>
                <input type="file" name="NewImages" multiple class="form-control" />
                <small class="text-muted">Bạn có thể chọn nhiều ảnh</small>
            </div>


            <div class="mb-4">
                <button type="submit" class="btn btn-success">Lưu thay đổi</button>
                <a asp-action="MyProducts" class="btn btn-secondary ms-2">Quay lại</a>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            $('#CategoryId').on('change', function () {
                var categoryId = $(this).val();
                $.ajax({
                    url: '/Products/GetSubCategoriesByCategory/' + categoryId, // <-- CHỈNH ĐOẠN NÀY
                    type: 'GET',
                    success: function (data) {
                        var subSelect = $('#SubCategoryId');
                        subSelect.empty();
                        $.each(data, function (i, item) {
                            subSelect.append($('<option>', {
                                value: item.value,
                                text: item.text
                            }));
                        });
                    },
                    error: function () {
                        alert('Không tải được danh sách loại sản phẩm.');
                    }
                });
            });
        });
    </script>
    <script>
        $(document).on('click', '.delete-image', function () {
            var imageId = $(this).data('id');
            if (confirm('Bạn có chắc muốn xóa ảnh này?')) {
                $.ajax({
                    url: '/Products/DeleteImage/' + imageId,
                    type: 'POST',
                    headers: {
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function (res) {
                        if (res.success) {
                            $('#image-' + imageId).remove();
                        } else {
                            alert(res.message || 'Xóa ảnh thất bại.');
                        }
                    },
                    error: function () {
                        alert('Có lỗi xảy ra khi xóa ảnh.');
                    }
                });
            }
        });
    </script>

}



