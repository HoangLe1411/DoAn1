@model PagedList.Core.IPagedList<DoAn1.Areas.Admin.Models.Product>

@{
    ViewData["Title"] = ViewBag.CategoryName ?? "Sản Phẩm";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var subCategories = ViewBag.SubCategories as List<DoAn1.Areas.Admin.Models.SubCategory> ?? new List<DoAn1.Areas.Admin.Models.SubCategory>();
    int? selectedSubCategoryId = ViewBag.SubCategoryId;
    string selectedPrice = ViewBag.Price ?? "";
    string selectedCondition = ViewBag.Condition ?? "";
}

@section Styles {
    <link rel="stylesheet" href="~/css/products.css" />
}

<div class="container mt-4">
    <h2>@ViewData["Title"]</h2>

    <!-- Bộ lọc -->
    <form method="get" class="filter-bar mb-4">
        <input type="hidden" name="categoryId" value="@ViewBag.CategoryId" />

        <span><i class="bi bi-funnel"></i> Lọc:</span>

        <select name="subCategoryId" class="form-select d-inline-block w-auto ms-2">
            <option value="">-- Loại --</option>
            @foreach (var sub in subCategories)
            {
                if (selectedSubCategoryId == sub.SubCategoryId)
                {
                    <option value="@sub.SubCategoryId" selected>@sub.SubCategoryName</option>
                }
                else
                {
                    <option value="@sub.SubCategoryId">@sub.SubCategoryName</option>
                }
            }
        </select>

        <select name="price" class="form-select d-inline-block w-auto ms-2">
            <option value="">-- Khoảng giá --</option>
            @if (selectedPrice == "0-100000")
            {
                <option value="0-100000" selected>Dưới 100,000đ</option>
            }
            else
            {
                <option value="0-100000">Dưới 100,000đ</option>
            }
            @if (selectedPrice == "100000-300000")
            {
                <option value="100000-300000" selected>100,000đ - 300,000đ</option>
            }
            else
            {
                <option value="100000-300000">100,000đ - 300,000đ</option>
            }
            @if (selectedPrice == "300000-500000")
            {
                <option value="300000-500000" selected>300,000đ - 500,000đ</option>
            }
            else
            {
                <option value="300000-500000">300,000đ - 500,000đ</option>
            }
            @if (selectedPrice == "500000-999999999")
            {
                <option value="500000-999999999" selected>Trên 500,000đ</option>
            }
            else
            {
                <option value="500000-999999999">Trên 500,000đ</option>
            }
        </select>

        <select name="condition" class="form-select d-inline-block w-auto ms-2">
            <option value="">-- Tình trạng --</option>
            @if (selectedCondition == "Mới")
            {
                <option value="Mới" selected>Mới</option>
            }
            else
            {
                <option value="Mới">Mới</option>
            }
            @if (selectedCondition == "Cũ")
            {
                <option value="Cũ" selected>Cũ</option>
            }
            else
            {
                <option value="Cũ">Cũ</option>
            }
        </select>

        <button type="submit" class="btn btn-primary ms-2">Lọc</button>
    </form>

    <div class="row">
        @foreach (var product in Model)
        {
            var imageUrl = product.ProductImages?.FirstOrDefault()?.ImageUrl ?? "/images/no-image.png";
            var price = product.Price ?? 0;
            <div class="col-md-3 mb-4">
                <div class="card h-100">
                    <img src="@imageUrl" class="card-img-top" alt="@product.Title" onerror="this.onerror=null;this.src='/images/no-image.png';" />
                    <div class="card-body">
                        <h5 class="card-title">@product.Title</h5>
                        <p class="card-text">@string.Format("{0:N0} đ", price)</p>
                        <a href="@Url.Action("DetailProduct", "Products", new { id = product.ProductId })" class="btn btn-outline-primary w-100">Xem chi tiết</a>
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- Phân trang -->
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            @if (Model.HasPreviousPage)
            {
                <li class="page-item">
                    <a class="page-link" href="@Url.Action("ByCategory", new { categoryId = ViewBag.CategoryId, page = Model.PageNumber - 1, subCategoryId = selectedSubCategoryId, price = selectedPrice, condition = selectedCondition })">«</a>
                </li>
            }
            @for (int i = 1; i <= Model.PageCount; i++)
            {
                <li class="page-item @(i == Model.PageNumber ? "active" : "")">
                    <a class="page-link" href="@Url.Action("ByCategory", new { categoryId = ViewBag.CategoryId, page = i, subCategoryId = selectedSubCategoryId, price = selectedPrice, condition = selectedCondition })">@i</a>
                </li>
            }
            @if (Model.HasNextPage)
            {
                <li class="page-item">
                    <a class="page-link" href="@Url.Action("ByCategory", new { categoryId = ViewBag.CategoryId, page = Model.PageNumber + 1, subCategoryId = selectedSubCategoryId, price = selectedPrice, condition = selectedCondition })">»</a>
                </li>
            }
        </ul>
    </nav>
</div>
