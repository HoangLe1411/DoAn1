@model DoAn1.Areas.Admin.Models.Product

@{
    ViewData["Title"] = "Đăng bán sản phẩm";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Styles {
    <link rel="stylesheet" href="~/css/create-product.css" />
}

<h2 class="mb-4">@ViewData["Title"]</h2>

<div class="row">
    <div class="col-md-8">
        @if (TempData["SuccessMessage"] != null)
        {
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                @TempData["SuccessMessage"]
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }

        <form asp-action="Create" enctype="multipart/form-data" class="create-product-form">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>

            <div class="form-group">
                <label asp-for="Title" class="control-label">Tên sản phẩm</label>
                <input asp-for="Title" class="form-control" />
                <span asp-validation-for="Title" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label asp-for="Description" class="control-label">Mô tả</label>
                <textarea asp-for="Description" class="form-control"></textarea>
                <span asp-validation-for="Description" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label asp-for="Price" class="control-label">Giá</label>
                <input asp-for="Price" class="form-control" />
                <span asp-validation-for="Price" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label asp-for="Condition" class="control-label">Tình trạng</label>
                <input asp-for="Condition" class="form-control" placeholder="Mới, đã sử dụng..." />
                <span asp-validation-for="Condition" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label asp-for="Location" class="control-label">Địa điểm</label>
                <input asp-for="Location" class="form-control" />
                <span asp-validation-for="Location" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label asp-for="CategoryId">Danh mục</label>
                <select asp-for="CategoryId" class="form-control" asp-items="ViewBag.CategoryId" id="CategoryId">
                    <option value="">-- Chọn danh mục --</option>
                </select>
                <span asp-validation-for="CategoryId" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label asp-for="SubCategoryId">Danh mục phụ</label>
                <select asp-for="SubCategoryId" class="form-control" id="SubCategoryId">
                    <option value="">-- Chọn danh mục phụ --</option>
                </select>
                <span asp-validation-for="SubCategoryId" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label asp-for="Brand" class="control-label">Thương hiệu</label>
                <input asp-for="Brand" class="form-control" />
                <span asp-validation-for="Brand" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label asp-for="WarrantyPeriod" class="control-label">Thời gian bảo hành</label>
                <input asp-for="WarrantyPeriod" class="form-control" placeholder="6 tháng, 1 năm..." />
                <span asp-validation-for="WarrantyPeriod" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label asp-for="UsedDuration" class="control-label">Đã sử dụng bao lâu</label>
                <input asp-for="UsedDuration" class="form-control" />
                <span asp-validation-for="UsedDuration" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label asp-for="Type" class="control-label">Loại hình sản phẩm</label>
                <input asp-for="Type" class="form-control" />
                <span asp-validation-for="Type" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label>Hình ảnh sản phẩm</label>
                <input type="file" name="Images" multiple class="form-control" />
                <small class="form-text text-muted">Bạn có thể chọn nhiều ảnh.</small>
            </div>

            <!-- Ẩn status và userId: hệ thống tự gán -->
            <input asp-for="Status" type="hidden" value="Chờ duyệt" />
            <input asp-for="UserId" type="hidden" />

            <button type="submit" class="btn btn-success">Đăng sản phẩm</button>
            <a asp-action="Index" class="btn btn-secondary ml-2">Hủy</a>
        </form>
    </div>
</div>

@section Scripts {
    @await Html.PartialAsync("_ValidationScriptsPartial")
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {

            function loadSubCategories(categoryId, selectedId) {
                var subSelect = $('#SubCategoryId');
                subSelect.empty();
                subSelect.append('<option value="">-- Chọn danh mục phụ --</option>');

                if (categoryId) {
                    $.ajax({
                        url: '/Products/GetSubCategoriesByCategory/' + categoryId,
                        type: 'GET',
                        success: function (data) {
                            $.each(data, function (i, item) {
                                var option = $('<option>', {
                                    value: item.value,
                                    text: item.text
                                });
                                if (selectedId && selectedId == item.value) {
                                    option.attr('selected', 'selected');
                                }
                                subSelect.append(option);
                            });
                        },
                        error: function () {
                            alert('Không tải được danh mục phụ.');
                        }
                    });
                }
            }

            // Khi thay đổi danh mục
            $('#CategoryId').on('change', function () {
                var categoryId = $(this).val();
                loadSubCategories(categoryId, null);
            });

            // Nếu đang ở chế độ Edit, load sẵn danh mục phụ (Create thì không cần)
            var selectedCategoryId = $('#CategoryId').val();
            var selectedSubCategoryId = $('#SubCategoryId').data('selected'); // Nếu có dữ liệu
            if (selectedCategoryId) {
                loadSubCategories(selectedCategoryId, selectedSubCategoryId);
            }
        });
    </script>
}



